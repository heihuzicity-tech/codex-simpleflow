# 工作流问题分析（实验总结)

## 背景
本次实验仅用于验证 CodexFlow 在本仓库内的自动化流程是否按设计可用，不以“用户登录功能”交付为目的。以下结论聚焦流程质量与可维护性。

## 当前结论
流程端到端可跑通（cc-start → 多次 cc-next → 预览/验证 → cc-end），但在可重复性、可读性、可追溯性方面存在改进空间，主要集中于编码与路径、工具调用一致性、文档引用结构、证据与验证、会话与检查点规范、服务/端口管理、环境与依赖，以及统计口径等。

## 主要问题
### 1) 编码与路径
Windows 控制台与文件写入方式混用导致中文出现乱码（如“�/�? ”）；中文特性名作为目录名在部分命令链路中表现不稳定，影响检索与补丁。

### 2) 工具调用与原子性
在 PowerShell 中误用 here‑doc 形式调用 `apply_patch`，多次失败重试；个别场合用脚本直接写 specs，造成换行/字段粘连（如 `next_action` 与 `updated_at` 同行）。

### 3) 文档结构与引用
`tasks.md` 的 `{ref}` 粒度较粗，难以精确定位到 `requirements/design` 的具体条目；当内容被编码破坏后，自动化引用进一步失效。

### 4) 证据与验证
验证以“能构建、能预览”为主，缺少与设计断言对齐的静态证据（例如路由存在性、受保护逻辑、跳转规则、组件存在性）。`cc-end` 对“设计一致性”的判断依赖人工说明。

### 5) 会话与检查点
出现过删除重建 `session.yml` 的情况；时间戳格式不统一（本地时区与带 Z 混用）；检查点与报告命名不一致，影响排序与追溯。

### 6) 服务与端口管理
启动/停止预览使用临时系统命令（`netstat`/`taskkill`），未形成统一抽象；PID/端口状态未标准化落入 specs，仅在对话中描述。

### 7) 环境与依赖
`cc-next` 执行前缺少环境前置校验（Node/Vite 等），首轮构建失败后再补跑；影响首发成功率和体验。

### 8) 统计与变更说明
构建产物与锁文件放大“代码行数/变更”噪音；在未 commit 的情况下，短统计的可读性与可比性较差。

## 输出显示格式问题（重点）
### 问题描述
对话输出中条目符号过多、层级密集，阅读负担较大；重点与结论不够突出，不利于人审阅。

### 改进原则
- 以短段落表达核心结论，减少层级与符号。
- 仅在需要操作步骤或清单时使用精简条目；控制在 4–6 条以内。
- 固定的结构顺序：结论 → 影响 → 建议/下一步；避免来回跳跃。
- 标题简短、语义明确；正文面向“人读”，非机器日志。

### 建议模板（示例）
结论：流程可跑通，但在编码与引用结构上存在系统性问题。
影响：自动化定位不稳、YAML 变更易出错、报告追溯成本高。
建议：统一 UTF‑8 与 slug；为 specs 增加锚点引用；新增“证据断言”与标准化服务控制命令。

## 最小改进建议（可在后续评审）
1) 统一 UTF‑8 写入，并为中文特性引入英文 slug 目录名（如 `login-page`），中文仅用于标题。
2) 所有 specs 写入一律使用 `apply_patch`；变更前做轻量 YAML 校验，失败即回滚。
3) 在 `requirements/design` 关键条目增加锚点 ID；`tasks.md` 的 `{ref}` 改为指向锚点。
4) 前端场景补充静态证据检查（路由/受保护逻辑/跳转规则/组件存在性），归档到 `reports/`。
5) 统一时间戳为 UTC（`YYYY-MM-DDThhmmssZ`），检查点/报告采用固定前缀并禁止删除重建 `session.yml`（仅字段更新）。
6) 抽象服务控制为命令（如 `cc-serve`）：启动/停止/状态写入 `specs/reports/serve.json`，并复用 `tools/port_kill.py`。
7) `cc-next` 开头加入环境校验（Node/Vite 等）；缺失时给出修复指引或转为“仅静态证据模式”。

## 备注
本报告聚焦流程层面的“问题与建议”，不涉及具体业务代码优劣；若后续需要，我可以据此起草命令模板与文档规范的最小修改提案，供评审。

